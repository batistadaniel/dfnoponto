<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>DF No Ponto - Veiculos em Tempo Real</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      html, body { height: 100%; margin: 0; box-sizing: border-box; }
      #map { width: 100%; height: 100%; }

      /* Popup ajustado para preencher totalmente a cor da operadora */
      .popup-content {
        padding: 3px;
        border-radius: 8px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        font-size: 14px;
        font-weight: bold;
        box-shadow: none;
      }
      .popup-content b { display: inline-block; width: 85px; }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      const map = L.map('map').setView([-15.7939, -47.8828], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const veiculosMarkers = {};

      const empresaCores = {
        "PIRACICABANA": "505558", //ff1e00    505558
        "PIONEIRA": "505558",
        "URBI": "505558",
        "MARECHAL": "505558",
        "BSBUS": "505558"
      };

      // Mapeamento dos ícones locais
      const icons = {
        "PIRACICABANA": L.icon({ iconUrl: "img/bus-piracicabana.png", iconSize: [24, 24], popupAnchor: [0, -24] }),
        "PIONEIRA": L.icon({ iconUrl: "img/bus-pioneira.png", iconSize: [24, 24], popupAnchor: [0, -24] }),
        "URBI": L.icon({ iconUrl: "img/bus-urbi.png", iconSize: [24, 24], popupAnchor: [0, -24] }),
        "MARECHAL": L.icon({ iconUrl: "img/bus-marechal.png", iconSize: [24, 24], popupAnchor: [0, -24] }),
        "BSBUS": L.icon({ iconUrl: "img/bus-bsbus.png", iconSize: [24, 24], popupAnchor: [0, -24] }),
      };

      const iconDefault = L.icon({ iconUrl: "img/bus-default.png", iconSize: [24, 24], popupAnchor: [0, -24] });

      function getContrasteTexto(hex) {
        const r = parseInt(hex.substr(0,2),16);
        const g = parseInt(hex.substr(2,2),16);
        const b = parseInt(hex.substr(4,2),16);
        const lumin = 0.299*r + 0.587*g + 0.114*b;
        return (lumin > 186) ? '#000000' : '#ffffff';
      }

      function formatPopupHtml(operadora, numero, linha, timestamp, hexColor) {
        const data = new Date(timestamp);
        const agora = new Date();

        const dataStr = data.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });
        const horaStr = data.toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo' });

        const diffMs = Math.max(0, agora - data);
        const diffM = Math.floor(diffMs / (1000*60));
        const diffS = Math.floor((diffMs % (1000*60))/1000);

        let ultimoSinal = (diffMs < 60000) ? `${diffS} sec` : `${diffM}min ${diffS}sec`;
        const textColor = getContrasteTexto(hexColor);

        return `
          <div class="popup-content" style="color:${textColor};">
            <style>
              .leaflet-popup-content-wrapper {
                background:#${hexColor} !important;
                box-shadow:none !important;
                //border: 2px solid black;

              }
              .leaflet-popup-tip {
                background:#${hexColor} !important;
                //border: 2px solid black;
              }
            </style>
            <div><b>Operadora:</b> ${operadora}</div>
            <div><b>Número:</b> ${numero}</div>
            <div><b>Linha:</b> ${linha}</div>
            <div><b>Data:</b> ${dataStr}</div>
            <div><b>Horário:</b> ${horaStr}</div>
            <div><b>Último Sinal:</b> ${ultimoSinal}</div>
          </div>`;
      }

      function operadoraPorNumero(numero) {
        const s = String(numero || '');
        const primeiro = s.charAt(0);
        switch (primeiro) {
          case '1': return 'PIRACICABANA';
          case '2': return 'PIONEIRA';
          case '3': return 'URBI';
          case '4': return 'MARECHAL';
          case '5':
          case '7': return 'BSBUS';
          default: return 'DESCONHECIDO';
        }
      }

      async function atualizarVeiculos() {
        try {
          const res = await fetch('https://www.sistemas.dftrans.df.gov.br/service/gps/operacoes');
          const dados = await res.json();

          dados.forEach(op => {
            (op.veiculos || []).forEach(v => {
              const lat = v.localizacao?.latitude;
              const lon = v.localizacao?.longitude;
              const numero = v.numero;
              const linha = v.linha;
              const horario = v.horario;

              if (lat == null || lon == null || numero == null) return;

              const operadora = operadoraPorNumero(numero);
              const hex = empresaCores[operadora] || '000000';
              const icon = icons[operadora] || iconDefault;

              const popupHtml = formatPopupHtml(operadora, numero, linha, horario, hex);

              if (veiculosMarkers[numero]) {
                const mk = veiculosMarkers[numero];
                mk.setLatLng([lat, lon]);
                mk.setPopupContent(popupHtml);
                if (mk.options.icon !== icon) mk.setIcon(icon);
              } else {
                const mk = L.marker([lat, lon], { icon }).addTo(map);
                mk.bindPopup(popupHtml);
                veiculosMarkers[numero] = mk;
              }
            });
          });

        } catch (err) {
          console.error('Erro ao atualizarVeiculos:', err);
        }
      }

      atualizarVeiculos();
      setInterval(atualizarVeiculos, 1000);
    </script>
  </body>
</html>
